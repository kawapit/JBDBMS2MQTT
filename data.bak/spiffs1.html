<!DOCTYPE HTML>
<html lang="en">
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <meta charset="UTF-8">
 <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
 <h1>SPIFFS File Manager</h1>
 <p>Build Time Stamp: %timestamp%</p>
 <p>SPIFFS Storage : <span id="totalspiffs">%total%</span> | Used : <span id="usedspiffs">%used%</span></p>
 <p>
 <button class='home_buttons' onclick="LogoutHandler()">Logout</button>
 <button class='home_buttons' onclick="RebootHandler()">Reboot</button>
 <button class='home_buttons' onclick="DirectoryHandler()">Directory</button>
 <button class='home_buttons' onclick="UploadHandler()">Upload</button>
 </p>
 <p id="status"></p>
 <p id="directory_header"></p>
 <p id="directory_details"></p>
 <p id="upload_header"></p>
 <p id="upload"></p>

<script>
function LogoutHandler() {
 var xhr = new XMLHttpRequest(); xhr.open("GET","/logout1",true); xhr.send();
 setTimeout(function(){ window.open("/logged-out","_self"); },1000);
}
function RebootHandler() {
 document.getElementById("status").innerHTML="invoking Reboot...";
 var xhr = new XMLHttpRequest(); xhr.open("GET","/reboot",true); xhr.send();
 setTimeout(function(){ window.open("/reboot1","_self"); },500);
}
function DirectoryHandler() {
 xmlhttp=new XMLHttpRequest(); xmlhttp.open("GET","/directory",false); xmlhttp.send();
 document.getElementById("directory_header").innerHTML="<h2>Files<h2>";
 document.getElementById("directory_details").innerHTML=xmlhttp.responseText;
}
function DirectoryButtonHandler(filename,action) {
 var urltocall = "/file?name=" + filename + "&action=" + action;
 xmlhttp=new XMLHttpRequest();
 if (action=="delete") {
 xmlhttp.open("GET",urltocall,false); xmlhttp.send();
 document.getElementById("status").innerHTML=xmlhttp.responseText;
 xmlhttp.open("GET","/directory",false); xmlhttp.send();
 document.getElementById("directory_details").innerHTML=xmlhttp.responseText;
 }
 if (action=="download") {
 document.getElementById("status").innerHTML="";
 window.open(urltocall,"_blank");
 }
}
function UploadHandler() {
 document.getElementById("upload_header").innerHTML="<h2>Upload File<h2>"
 document.getElementById("status").innerHTML="";
 var uploadform=
 "<form id=\"upload_form\" enctype=\"multipart/form-data\" method=\"post\">" +
 "<input type=\"file\" name=\"file1\" id=\"file1\" onchange=\"uploadFile()\"><br>" +
 "<progress id=\"progressBar\" value=\"0\" max=\"100\" style=\"width:300px;\"></progress>" +
 "<h3 id=\"status\"></h3>" +
 "<p id=\"loaded_n_total\"></p>" +
 "</form>";
 document.getElementById("upload").innerHTML=uploadform;
}
function _(el) {
 return document.getElementById(el);
}

function uploadFile() {
 var file=_("file1").files[0];
 // alert(file.name+" | "+file.size+" | "+file.type);
 var formdata=new FormData();
 formdata.append("file1",file);
 var ajax=new XMLHttpRequest();
 ajax.upload.addEventListener("progress",progressHandler,false);
 ajax.addEventListener("load",completeHandler,false); // doesnt appear to ever get called even upon success
 ajax.addEventListener("error",errorHandler,false);
 ajax.addEventListener("abort",abortHandler,false);
 ajax.open("POST","/");
 ajax.send(formdata);
}

function progressHandler(event) {_("loaded_n_total").innerHTML="Uploaded "+event.loaded+" bytes";
 var percent=(event.loaded/event.total)*100;
 _("progressBar").value=Math.round(percent);
 _("status").innerHTML=Math.round(percent)+"% uploaded... please wait";
 if (percent>=100) {
 _("status").innerHTML="done";
 document.getElementById("directory_header").innerHTML="";
 document.getElementById("directory_details").innerHTML="";
 document.getElementById("upload_header").innerHTML="";
 document.getElementById("upload").innerHTML="";
 }
}

function completeHandler(event) {_("status").innerHTML="Upload complete"; _("progressBar").value=0;
 xmlhttp=new XMLHttpRequest(); xmlhttp.open("GET","/directory",false); xmlhttp.send();
 document.getElementById("status").innerHTML="File uploaded";
 document.getElementById("directory_header").innerHTML="<h2>Files<h2>";
 document.getElementById("directory_details").innerHTML=xmlhttp.responseText;
 document.getElementById("upload_header").innerHTML="";
 document.getElementById("upload").innerHTML="";
}
function errorHandler(event) {_("status").innerHTML="Upload failed";}
function abortHandler(event) {_("status").innerHTML="aborted";}
</script>
</body>
</html>
